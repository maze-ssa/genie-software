#!/bin/bash -xe
# Log user-data
exec > >(tee -a /var/log/user-data.log) 2>&1

APP_DIR="/opt/genie/app"
APP_USER="ec2-user"

# === OS deps & Node.js 20 LTS ===
dnf update -y
dnf install -y git unzip tar gcc make openssl openssl-devel
curl -fsSL https://rpm.nodesource.com/setup_20.x | bash -
dnf install -y nodejs

# === App directory & code ===
mkdir -p "$APP_DIR/tls"
chown -R ${APP_USER}:${APP_USER} /opt/genie

# Pull your app code (replace with S3 artifact if you prefer)
if [ ! -f "$APP_DIR/server.js" ]; then
  su - ${APP_USER} -c "git clone https://github.com/maze-ssa/genie-software.git /opt/genie"
fi

# Install dependencies
cd "$APP_DIR"
su - ${APP_USER} -c "cd ${APP_DIR} && (npm ci || npm install)"

# === TLS for bootstrap (self-signed) ===
if [ ! -s "$APP_DIR/tls/server.key" ] || [ ! -s "$APP_DIR/tls/server.crt" ]; then
  openssl req -x509 -newkey rsa:2048 -keyout "$APP_DIR/tls/server.key" \
    -out "$APP_DIR/tls/server.crt" -days 365 -nodes \
    -subj "/CN=app-internal.genie-software.com"
  chown ${APP_USER}:${APP_USER} "$APP_DIR/tls/server.key" "$APP_DIR/tls/server.crt"
  chmod 600 "$APP_DIR/tls/server.key"
fi

# === Systemd env file (NO DB VARS) ===
mkdir -p /etc/sysconfig
cat >/etc/sysconfig/genie-app <<EOF
APP_PORT=8443
APP_HOST=0.0.0.0
TLS_CERT_PATH=${APP_DIR}/tls/server.crt
TLS_KEY_PATH=${APP_DIR}/tls/server.key
# No DB_* variables for now
EOF
chmod 600 /etc/sysconfig/genie-app

# === Systemd unit ===
cat >/etc/systemd/system/genie-app.service <<'EOF'
[Unit]
Description=Genie Intranet App (HTTPS on 8443)
After=network-online.target
Wants=network-online.target

[Service]
User=ec2-user
Group=ec2-user
WorkingDirectory=/opt/genie/app
EnvironmentFile=-/etc/sysconfig/genie-app
ExecStart=/usr/bin/node server.js
Restart=always
RestartSec=5
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=full
ProtectHome=true

[Install]
WantedBy=multi-user.target
EOF

# === DO NOT run DB migrations ===
# (intentionally skipped while DB is not configured)

# Start service
systemctl daemon-reload
systemctl enable --now genie-app

# Local health check
curl -sk https://127.0.0.1:8443/healthz || true
