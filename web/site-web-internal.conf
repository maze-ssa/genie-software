# Web tier virtual host (behind internal ALB)
server {
  listen 80;
  server_name web-internal.genie-software.com _;

  # Simple health endpoint for ALB
  location = /healthz {
    return 200 "ok\n";
    add_header Content-Type text/plain;
  }

  # (Optional) a basic landing page
  location = / {
    return 200 "Genie intranet web tier OK\n";
    add_header Content-Type text/plain;
  }

  # === App proxy (to NLB â†’ app instances on HTTPS :8443) ===
  # Resolve at request time to avoid reload failures if DNS is not yet ready
  set $app_host app-internal.genie-software.com;

  location /api/ {
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # TLS to the app on 8443
    proxy_ssl_server_name on;  # send SNI = $app_host
    proxy_ssl_name        $app_host;

    # During bootstrap (self-signed on app): keep verify off.
    # Once you use ACM Private CA / trusted certs, switch to 'on' and add trusted chain.
    proxy_ssl_verify off;
    # proxy_ssl_verify on;
    # proxy_ssl_trusted_certificate /etc/nginx/trusted/private-ca.pem;

    proxy_pass https://$app_host:8443;
  }
}
